<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Portal - Inhouse Africa Technologies</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .glass {
      background: rgba(255, 255, 255, 0.1);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .lead-card {
      transition: all 0.3s ease;
    }
    .lead-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body class="p-4 md:p-8">
  <!-- Login Screen -->
  <div id="loginScreen" class="max-w-md mx-auto mt-20">
    <div class="glass rounded-2xl p-8 shadow-2xl">
      <div class="text-center mb-8">
        <i class="fas fa-shield-alt text-6xl text-white mb-4"></i>
        <h1 class="text-3xl font-bold text-white mb-2">Admin Portal</h1>
        <p class="text-gray-200">Inhouse Africa Technologies</p>
      </div>
      
      <form id="loginForm" class="space-y-6">
        <div>
          <label for="password" class="block text-sm font-medium text-white mb-2">
            <i class="fas fa-lock mr-2"></i>Password
          </label>
          <input 
            type="password" 
            id="password" 
            name="password"
            class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:border-transparent"
            placeholder="Enter admin password"
            required
            autocomplete="current-password"
          />
        </div>
        
        <button 
          type="submit" 
          id="loginBtn"
          class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-offset-2"
        >
          <i class="fas fa-sign-in-alt mr-2"></i>Login
        </button>
        
        <p id="loginError" class="text-red-300 text-sm text-center hidden"></p>
      </form>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminDashboard" class="hidden max-w-7xl mx-auto">
    <!-- Header -->
    <div class="glass rounded-2xl p-6 mb-6 shadow-2xl">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
          <h1 class="text-3xl font-bold text-white mb-2">
            <i class="fas fa-tachometer-alt mr-3"></i>Lead Dashboard
          </h1>
          <p class="text-gray-200">Manage your quote requests and contacts</p>
        </div>
        
        <div class="flex gap-3">
          <button 
            id="refreshBtn"
            class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded-lg transition-all duration-300 flex items-center gap-2"
          >
            <i class="fas fa-sync-alt"></i>
            Refresh
          </button>
          <button 
            id="logoutBtn"
            class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg transition-all duration-300 flex items-center gap-2"
          >
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </button>
        </div>
      </div>
      
      <!-- Stats -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
        <div class="bg-white/10 rounded-lg p-4 border border-white/20">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-200 text-sm mb-1">Total Leads</p>
              <p id="totalLeads" class="text-3xl font-bold text-white">0</p>
            </div>
            <i class="fas fa-users text-4xl text-purple-300"></i>
          </div>
        </div>
        
        <div class="bg-white/10 rounded-lg p-4 border border-white/20">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-200 text-sm mb-1">Today</p>
              <p id="todayLeads" class="text-3xl font-bold text-white">0</p>
            </div>
            <i class="fas fa-calendar-day text-4xl text-blue-300"></i>
          </div>
        </div>
        
        <div class="bg-white/10 rounded-lg p-4 border border-white/20">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-200 text-sm mb-1">This Week</p>
              <p id="weekLeads" class="text-3xl font-bold text-white">0</p>
            </div>
            <i class="fas fa-chart-line text-4xl text-green-300"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="glass rounded-2xl p-6 mb-6 shadow-2xl">
      <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
          <label class="block text-sm font-medium text-white mb-2">
            <i class="fas fa-search mr-2"></i>Search
          </label>
          <input 
            type="text" 
            id="searchInput"
            placeholder="Search by name, email, company..."
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400"
          />
        </div>
        
        <div class="flex-1">
          <label class="block text-sm font-medium text-white mb-2">
            <i class="fas fa-filter mr-2"></i>Project Type
          </label>
          <select 
            id="projectTypeFilter"
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-purple-400"
          >
            <option value="">All Types</option>
            <option value="AI Integration">AI Integration</option>
            <option value="Website Development">Website Development</option>
            <option value="Mobile App">Mobile App</option>
            <option value="Cloud Migration">Cloud Migration</option>
            <option value="Data Analytics">Data Analytics</option>
            <option value="Other">Other</option>
          </select>
        </div>
        
        <div class="flex-1">
          <label class="block text-sm font-medium text-white mb-2">
            <i class="fas fa-sort mr-2"></i>Sort By
          </label>
          <select 
            id="sortFilter"
            class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-purple-400"
          >
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="name">Name (A-Z)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="glass rounded-2xl p-12 text-center shadow-2xl">
      <i class="fas fa-spinner fa-spin text-6xl text-white mb-4"></i>
      <p class="text-white text-xl">Loading leads...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden glass rounded-2xl p-12 text-center shadow-2xl">
      <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
      <p class="text-white text-xl mb-2">Failed to load leads</p>
      <p id="errorMessage" class="text-gray-200 mb-4"></p>
      <button onclick="loadLeads()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg">
        Try Again
      </button>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden glass rounded-2xl p-12 text-center shadow-2xl">
      <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
      <p class="text-white text-xl mb-2">No leads yet</p>
      <p class="text-gray-200">Quote requests will appear here</p>
    </div>

    <!-- Leads Grid -->
    <div id="leadsContainer" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Lead cards will be inserted here -->
    </div>
  </div>

  <script>
    // Configuration
    const API_BASE = 'https://inhouse-africa-tech.onrender.com';
    
    let ADMIN_PASSWORD_HASH = null; // Will be fetched from server
    let allLeads = [];
    let isAuthenticated = false;
    
    // Fetch admin password hash from server on load
    async function fetchAdminHash() {
      try {
        const response = await fetch(`${API_BASE}/api/admin/hash`);
        const data = await response.json();
        ADMIN_PASSWORD_HASH = data.hash;
      } catch (err) {
        console.error('Failed to fetch admin hash:', err);
        // Fallback to default (change this in production!)
        ADMIN_PASSWORD_HASH = 'e99a18c428cb38d5f260853678922e03';
      }
    }

    // Simple MD5 hash function
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Check if already authenticated
    function checkAuth() {
      const authToken = sessionStorage.getItem('adminAuth');
      if (authToken === ADMIN_PASSWORD_HASH) {
        isAuthenticated = true;
        showDashboard();
        loadLeads();
      }
    }

    // Login handler
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const password = document.getElementById('password').value;
      const loginError = document.getElementById('loginError');
      const loginBtn = document.getElementById('loginBtn');
      
      loginBtn.disabled = true;
      loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Checking...';
      
      try {
        // Ensure hash is fetched
        if (!ADMIN_PASSWORD_HASH) {
          await fetchAdminHash();
        }
        
        const hash = await hashPassword(password);
        
        if (hash === ADMIN_PASSWORD_HASH) {
          sessionStorage.setItem('adminAuth', hash);
          isAuthenticated = true;
          loginError.classList.add('hidden');
          showDashboard();
          loadLeads();
        } else {
          loginError.textContent = 'Invalid password';
          loginError.classList.remove('hidden');
          document.getElementById('password').value = '';
        }
      } catch (err) {
        loginError.textContent = 'Login error. Please try again.';
        loginError.classList.remove('hidden');
      } finally {
        loginBtn.disabled = false;
        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Login';
      }
    });

    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', () => {
      sessionStorage.removeItem('adminAuth');
      isAuthenticated = false;
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('adminDashboard').classList.add('hidden');
      document.getElementById('password').value = '';
    });

    // Show dashboard
    function showDashboard() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('adminDashboard').classList.remove('hidden');
    }

    // Load leads from API
    async function loadLeads() {
      if (!isAuthenticated) return;
      
      const loadingState = document.getElementById('loadingState');
      const errorState = document.getElementById('errorState');
      const emptyState = document.getElementById('emptyState');
      const leadsContainer = document.getElementById('leadsContainer');
      
      loadingState.classList.remove('hidden');
      errorState.classList.add('hidden');
      emptyState.classList.add('hidden');
      leadsContainer.classList.add('hidden');
      
      try {
        const response = await fetch(`${API_BASE}/api/leads`);
        if (!response.ok) throw new Error('Failed to fetch leads');
        
        const data = await response.json();
        allLeads = data.leads || [];
        
        updateStats();
        displayLeads(allLeads);
        
        loadingState.classList.add('hidden');
        
        if (allLeads.length === 0) {
          emptyState.classList.remove('hidden');
        } else {
          leadsContainer.classList.remove('hidden');
        }
      } catch (err) {
        console.error('Error loading leads:', err);
        loadingState.classList.add('hidden');
        errorState.classList.remove('hidden');
        document.getElementById('errorMessage').textContent = err.message;
      }
    }

    // Update statistics
    function updateStats() {
      const now = new Date();
      const today = now.toISOString().split('T')[0];
      const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
      
      const todayCount = allLeads.filter(lead => lead.ts.startsWith(today)).length;
      const weekCount = allLeads.filter(lead => new Date(lead.ts) >= weekAgo).length;
      
      document.getElementById('totalLeads').textContent = allLeads.length;
      document.getElementById('todayLeads').textContent = todayCount;
      document.getElementById('weekLeads').textContent = weekCount;
    }

    // Display leads
    function displayLeads(leads) {
      const container = document.getElementById('leadsContainer');
      
      if (leads.length === 0) {
        container.classList.add('hidden');
        document.getElementById('emptyState').classList.remove('hidden');
        return;
      }
      
      container.innerHTML = leads.map(lead => createLeadCard(lead)).join('');
      container.classList.remove('hidden');
      document.getElementById('emptyState').classList.add('hidden');
    }

    // Create lead card HTML
    function createLeadCard(lead) {
      const date = new Date(lead.ts);
      const formattedDate = date.toLocaleString('en-ZA', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      const projectTypeColors = {
        'AI Integration': 'bg-purple-500',
        'Website Development': 'bg-blue-500',
        'Mobile App': 'bg-green-500',
        'Cloud Migration': 'bg-cyan-500',
        'Data Analytics': 'bg-pink-500',
        'Other': 'bg-gray-500'
      };
      
      const badgeColor = projectTypeColors[lead.projectType] || 'bg-gray-500';
      
      return `
        <div class="lead-card glass rounded-2xl p-6 shadow-xl">
          <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
              <h3 class="text-xl font-bold text-white mb-1">
                <i class="fas fa-user mr-2"></i>${escapeHtml(lead.name)}
              </h3>
              <p class="text-gray-200 text-sm">
                <i class="fas fa-clock mr-1"></i>${formattedDate}
              </p>
            </div>
            <span class="${badgeColor} text-white text-xs px-3 py-1 rounded-full font-semibold">
              ${escapeHtml(lead.projectType)}
            </span>
          </div>
          
          <div class="space-y-3 mb-4">
            <div class="flex items-center text-gray-200">
              <i class="fas fa-envelope w-5 mr-3 text-purple-300"></i>
              <a href="mailto:${escapeHtml(lead.email)}" class="hover:text-white transition-colors">
                ${escapeHtml(lead.email)}
              </a>
            </div>
            
            ${lead.phone ? `
              <div class="flex items-center text-gray-200">
                <i class="fas fa-phone w-5 mr-3 text-green-300"></i>
                <a href="tel:${escapeHtml(lead.phone)}" class="hover:text-white transition-colors">
                  ${escapeHtml(lead.phone)}
                </a>
              </div>
            ` : ''}
            
            ${lead.company ? `
              <div class="flex items-center text-gray-200">
                <i class="fas fa-building w-5 mr-3 text-blue-300"></i>
                ${escapeHtml(lead.company)}
              </div>
            ` : ''}
            
            ${lead.budget ? `
              <div class="flex items-center text-gray-200">
                <i class="fas fa-money-bill w-5 mr-3 text-yellow-300"></i>
                ${escapeHtml(lead.budget)}
              </div>
            ` : ''}
            
            ${lead.timeline ? `
              <div class="flex items-center text-gray-200">
                <i class="fas fa-calendar w-5 mr-3 text-pink-300"></i>
                ${escapeHtml(lead.timeline)}
              </div>
            ` : ''}
          </div>
          
          <div class="bg-white/5 rounded-lg p-4 border border-white/10">
            <p class="text-sm font-semibold text-white mb-2">
              <i class="fas fa-comment-dots mr-2"></i>Project Details:
            </p>
            <p class="text-gray-200 text-sm whitespace-pre-wrap">${escapeHtml(lead.details)}</p>
          </div>
          
          <div class="mt-4 pt-4 border-t border-white/10 flex gap-2">
            <a 
              href="mailto:${escapeHtml(lead.email)}?subject=Re: Quote Request - ${escapeHtml(lead.projectType)}"
              class="flex-1 bg-purple-600 hover:bg-purple-700 text-white text-center py-2 px-4 rounded-lg transition-all duration-300 text-sm font-semibold"
            >
              <i class="fas fa-reply mr-2"></i>Reply
            </a>
            <a 
              href="https://wa.me/${encodeURIComponent(lead.phone?.replace(/\D/g, ''))}?text=Hi ${encodeURIComponent(lead.name)}, thank you for your quote request!"
              target="_blank"
              class="flex-1 bg-green-600 hover:bg-green-700 text-white text-center py-2 px-4 rounded-lg transition-all duration-300 text-sm font-semibold ${!lead.phone ? 'opacity-50 pointer-events-none' : ''}"
            >
              <i class="fab fa-whatsapp mr-2"></i>WhatsApp
            </a>
          </div>
        </div>
      `;
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return String(text || '').replace(/[&<>"']/g, m => map[m]);
    }

    // Filter and search functionality
    function filterLeads() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const projectType = document.getElementById('projectTypeFilter').value;
      const sortBy = document.getElementById('sortFilter').value;
      
      let filtered = [...allLeads];
      
      // Search filter
      if (searchTerm) {
        filtered = filtered.filter(lead => 
          lead.name.toLowerCase().includes(searchTerm) ||
          lead.email.toLowerCase().includes(searchTerm) ||
          (lead.company || '').toLowerCase().includes(searchTerm) ||
          lead.details.toLowerCase().includes(searchTerm)
        );
      }
      
      // Project type filter
      if (projectType) {
        filtered = filtered.filter(lead => lead.projectType === projectType);
      }
      
      // Sort
      if (sortBy === 'newest') {
        filtered.sort((a, b) => new Date(b.ts) - new Date(a.ts));
      } else if (sortBy === 'oldest') {
        filtered.sort((a, b) => new Date(a.ts) - new Date(b.ts));
      } else if (sortBy === 'name') {
        filtered.sort((a, b) => a.name.localeCompare(b.name));
      }
      
      displayLeads(filtered);
    }

    // Event listeners for filters
    document.getElementById('searchInput').addEventListener('input', filterLeads);
    document.getElementById('projectTypeFilter').addEventListener('change', filterLeads);
    document.getElementById('sortFilter').addEventListener('change', filterLeads);
    document.getElementById('refreshBtn').addEventListener('click', loadLeads);

    // Initialize - fetch admin hash first, then check auth
    fetchAdminHash().then(() => {
      checkAuth();
    });
  </script>
</body>
</html>
